# Домашнее задание к занятию "08.02 Работа с Playbook"

## Основная часть
1. Приготовьте свой собственный inventory файл `prod.yml`.

Я приготовил fr.yml, который описывает машину с Debian Linux в локальной подседти моей организации. Пароли добавил свойства ansible_ssh_pass и 
ansible_sudo_pass, затем зашифровал файл. Так же внёс пользователя devops в /etc/sudoers, поскольку скрипт требует повышения привелегий.

2. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает kibana.
3. При создании tasks рекомендую использовать модули: `get_url`, `template`, `unarchive`, `file`.
4. Tasks должны: скачать нужной версии дистрибутив, выполнить распаковку в выбранную директорию, сгенерировать конфигурацию с параметрами.
5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

Ошибок нет. Есть замечания.

6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

С флагом --check playbook выходит с ошибкой. Долго разбирался с проблемой. Оказалось дело в том, что в этом режиме директория, определённая
в JAVA_HOME? не создаётся, поэтому на этапе распаковки ansible не находит директорию и останавливается с ошибкой. Если запускать без --check,
то операция распаковки проходит корректно. Пришлось долго искать причину, казалось что переменная java_home не определена, но режим отладки помог
докопаться до источника проблемы.

7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.

Очень уж долго ждать повторной загрузки Kibana, поэтому я добавил проверку на то, что архив уже загружен.

```yaml
    - name: Check if Kibana already downloaded
      stat:
        path: "/tmp/kibana-{{ kibana_version }}-linux-x86_64.tar.gz"
      register: kiload
      tags: kibana
    - name: Uploaad Kibana form remote URL
      get_url: 
        url: "https://artifacts.elastic.co/downloads/kibana/kibana-{{ kibana_version }}-linux-x86_64.tar.gz"
        dest: "/tmp/kibana-{{ kibana_version }}-linux-x86_64.tar.gz"
        mode: 0666
        timeout: 60
        force: true
        validate_certs: false
      register: get_kibana
      when: not kiload.stat.exists
      until: get_kibana is succeeded
      tags: kibana
```

Сколько бы раз я не запускал плейбук, результат идентичен:

<pre>
devops@frcloud2:~/ansible/alman/mnt-homeworks/08-ansible-02-playbook/playbook$
./r.sh

PLAY [Install Java] *************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [frc1]

PLAY [Install Elasticsearch] ****************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [frc1]

PLAY [Install Kibana] ***********************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************
ok: [frc1]

TASK [Check if Kibana already downloaded] ***************************************************************************************************************************************************
ok: [frc1]

TASK [Uploaad Kibana form remote URL] *******************************************************************************************************************************************************
skipping: [frc1]

TASK [Create directory for Kibana] **********************************************************************************************************************************************************
ok: [frc1]

TASK [Extract Kibana to the installation directory] *****************************************************************************************************************************************
skipping: [frc1]

TASK [Set Kibana environment] ***************************************************************************************************************************************************************
ok: [frc1]

PLAY RECAP **********************************************************************************************************************************************************************************
frc1                       : ok=6    changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0

</pre>

Можно утверждать что playbook идемпотентен

<!--
## Необязательная часть

1. Приготовьте дополнительный хост для установки logstash.
2. Пропишите данный хост в `prod.yml` в новую группу `logstash`.
3. Дополните playbook ещё одним play, который будет исполнять установку logstash только на выделенный для него хост.
4. Все переменные для нового play определите в отдельный файл `group_vars/logstash/vars.yml`.
5. Logstash конфиг должен конфигурироваться в части ссылки на elasticsearch (можно взять, например его IP из facts или определить через vars).
6. Дополните README.md, протестируйте playbook, выложите новую версию в github. В ответ предоставьте ссылку на репозиторий.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---

-->
